# SAM4DBodyCapture v0.2.0 Design

## Pipeline Overview

```
                        SAM-Body4D Pipeline
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                      â”‚
â”‚  Video â”€â”€â–º SAM3 â”€â”€â–º Masks â”€â”€â–º Occlusion Detection â”€â”€â–º SAM3DBody    â”‚
â”‚             â”‚                        â”‚                    â”‚          â”‚
â”‚             â”‚                   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”               â”‚          â”‚
â”‚             â”‚                   â”‚ Diffusionâ”‚               â”‚          â”‚
â”‚             â”‚                   â”‚   VAS    â”‚               â–¼          â”‚
â”‚             â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          4D Meshes       â”‚
â”‚             â”‚                        â”‚                    â”‚          â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â–º Depth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚          â”‚
â”‚                                                           â–¼          â”‚
â”‚                                                   Temporal Fusion    â”‚
â”‚                                                           â”‚          â”‚
â”‚                                                           â–¼          â”‚
â”‚                                              Export (FBX/Alembic)    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Existing ComfyUI Nodes (External)

| Package | Nodes | We Use? |
|---------|-------|---------|
| ComfyUI-SAM3 | SAM3 Loader, SAM3 Segmenter, SAM3 Video Propagator | âœ… Yes |
| ComfyUI-SAM3DBody | SAM3DBody Loader, SAM3DBody Estimator | âœ… Yes |

## New Nodes in v0.2.0

### 1. ðŸŽ­ SAM4D Pipeline Loader
Loads all models for the complete pipeline.

**Inputs:**
- depth_model: enum (Large/Base/Small)
- enable_occlusion_handling: bool
- device: enum (cuda/cpu/auto)
- dtype: enum (float16/float32)

**Outputs:**
- SAM4D_PIPELINE: dict containing all loaded models

### 2. ðŸ” SAM4D Occlusion Detector
Detects occluded frames by comparing modal vs amodal masks.

**Inputs:**
- pipeline: SAM4D_PIPELINE
- images: IMAGE (video frames)
- masks: MASK (from SAM3)
- iou_threshold: float (default 0.7)

**Outputs:**
- occlusion_info: dict {frame_idx: is_occluded}
- depth_maps: IMAGE (for visualization)

### 3. ðŸŽ­ SAM4D Amodal Completion
Completes occluded masks and RGB using Diffusion-VAS.

**Inputs:**
- pipeline: SAM4D_PIPELINE
- images: IMAGE
- masks: MASK  
- occlusion_info: dict
- num_frames: int

**Outputs:**
- amodal_masks: MASK
- completed_images: IMAGE (optional)

### 4. ðŸ‚ SAM4D Mesh Batch Processor
Wrapper around SAM3DBody that handles batches with occlusion-aware masks.

**Inputs:**
- sam3dbody_model: SAM3DBODY_MODEL (from ComfyUI-SAM3DBody)
- images: IMAGE
- masks: MASK (can be amodal)
- batch_size: int

**Outputs:**
- mesh_sequence: SAM4D_MESH_SEQUENCE
- rendered_frames: IMAGE

### 5. ðŸ”„ SAM4D Temporal Fusion
Smooths mesh parameters across frames using Kalman filtering.

**Inputs:**
- mesh_sequence: SAM4D_MESH_SEQUENCE
- smoothing_strength: float
- use_kalman: bool

**Outputs:**
- smoothed_sequence: SAM4D_MESH_SEQUENCE

### 6. ðŸ“¦ SAM4D Export Mesh Sequence
Exports mesh sequence to FBX or Alembic.

**Inputs:**
- mesh_sequence: SAM4D_MESH_SEQUENCE
- format: enum (FBX/Alembic/OBJ_sequence)
- fps: float
- coordinate_system: enum (Maya/Blender/Unreal/Unity)

**Outputs:**
- filepath: STRING

## Implementation Priority

### Phase 1 (v0.2.0-alpha)
1. SAM4D_PipelineLoader - Basic model loading
2. SAM4D_OcclusionDetector - IoU-based detection
3. SAM4D_AmodalCompletion - Diffusion-VAS wrapper

### Phase 2 (v0.2.0-beta)
4. SAM4D_MeshBatchProcessor - SAM3DBody wrapper
5. SAM4D_TemporalFusion - Kalman smoothing

### Phase 3 (v0.2.0-release)
6. SAM4D_ExportMeshSequence - FBX/Alembic export

## Data Types

```python
# Custom data types for ComfyUI

SAM4D_PIPELINE = {
    "depth_estimator": DepthEstimator,
    "amodal_pipeline": DiffusionVASPipeline | None,
    "completion_pipeline": DiffusionVASPipeline | None,
    "config": dict,
}

SAM4D_OCCLUSION_INFO = {
    "frame_indices": List[int],        # Occluded frame indices
    "iou_scores": List[float],         # Per-frame IoU
    "occlusion_ranges": List[Tuple],   # (start, end) ranges
}

SAM4D_MESH_SEQUENCE = {
    "vertices": List[np.ndarray],      # Per-frame vertices
    "faces": np.ndarray,               # Shared topology
    "params": dict,                     # SMPL/HMR parameters per frame
    "frame_count": int,
    "fps": float,
}
```

## Integration with Existing Nodes

### Workflow Example
```
Load Video
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SAM3 Loader â”‚ (from ComfyUI-SAM3)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SAM3 Propagator â”‚ (from ComfyUI-SAM3)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ masks
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SAM4D Pipeline Loaderâ”‚ (NEW)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SAM4D Occlusion Detect â”‚ (NEW)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SAM4D Amodal Completion   â”‚ (NEW - optional)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ amodal_masks
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SAM3DBody Loader â”‚ (from ComfyUI-SAM3DBody)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SAM4D Mesh Batch Process â”‚ (NEW)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SAM4D Temporal Fusion â”‚ (NEW)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SAM4D Export Mesh Seq.  â”‚ (NEW)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Dependencies

```
Required:
- torch >= 2.0
- numpy
- opencv-python
- Pillow
- scipy (for Kalman filter)
- diffusers >= 0.25.0
- transformers

Optional for Export:
- bpy (Blender Python - for FBX via Blender)
- alembic (pip install alembic-python or system install)
```
